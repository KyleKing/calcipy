---
version: 0.2.0a0.{build}

image:
  - Ubuntu
  - Visual Studio 2019

environment:
  # Python versions
  #   Windows: https://www.appveyor.com/docs/windows-images-software/#python
  #   Linux: https://www.appveyor.com/docs/linux-images-software/#python
  matrix:
    # Use a single global Python version for pipx/poetry/etc.
    #   Nox will handle specific python version testing
    - PYTHON_WIN: C:/Python39
      PYTHON_STACK: 3.9

  APPVEYOR_SAVE_CACHE_ON_ERROR: true
  CODECOV_TOKEN: d414dacb-5b8d-4c0b-94e1-42fe8393187d

  # To encrypt passwords, go to Account -> "Settings" -> "Encrypt YAML"

# Must be after the declaration of "PYTHON_STACK" variable
# yamllint disable-line rule:line-length
# https://help.appveyor.com/discussions/questions/32001-ubuntu-python-3-as-default
stack: python %PYTHON_STACK%

cache:
  - .venv -> poetry.lock

build: false

# Specify commands specific to platform (cmd-Windows/sh-Linux/None-Both)
install:
  # Set Python paths based on environment variable from matrix
  - cmd: set PATH=%PYTHON_WIN%/Scripts;%PYTHON_WIN%;%PATH%
  - python --version
  # Install pipx to manage CLI installations (poetry, codecov)
  - python -m pip install pipx
  # Manually set the path because "pipx ensurepath" needs a reload to apply
  - cmd: set PATH=%USERPROFILE%\.local\bin;%PATH%
  - sh: PATH=~/.local/bin:$PATH
  # Debug the PATH (if needed)
  - cmd: echo %PATH%
  - sh: echo $PATH
  # Install poetry and configure
  - python -m pipx install poetry
  - poetry config --list
  - poetry config virtualenvs.in-project true
  # Install project-specific dependencies and extras
  - poetry install -E dev -E lint -E test -E commitizen_legacy

test_script:
  - poetry run doit
  # Install codecov and upload the coverage results
  - python -m pipx install codecov
  - codecov

deploy_script:
  - echo "Deploying..."

on_success:
  - echo "On Success..."

on_failure:
  - echo "On Error..."

artifacts:
  # PLANNED: Specify single files, like wheels, but zip the docs/reports
  - path: releases/tests/*
