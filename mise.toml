[env]
_.python.venv = {path = ".venv"}

[tasks.calcipy]
description = "Run any calcipy task (passthrough)"
run = "uv run calcipy ${usage_args?}"
usage = 'arg "<args>" var=#true help="Task and arguments for calcipy"'

[tasks."doc:watch"]
description = "Serve docs locally with live reload"
run = "uv run mkdocs serve --dirtyreload"

[tasks."lint:check"]
description = "Run ruff check"
run = "uv run ruff check ./src/calcipy ./tests"

[tasks."lint:fix"]
description = "Run ruff with fixes"
run = '''
#!/usr/bin/env bash
unsafe_flag=""
if [ "${usage_unsafe:-false}" = "true" ]; then
  unsafe_flag="--unsafe-fixes"
fi
uv run ruff check --fix $unsafe_flag ./src/calcipy ./tests
'''
usage = 'flag "-u --unsafe" help="Apply unsafe fixes"'

[tasks."lint:watch"]
description = "Run ruff in watch mode"
run = "uv run ruff check --watch ./src/calcipy ./tests"

[tasks.lock]
description = "Update uv lock file"
run = "uv lock"

[tasks.nox]
description = "Run nox sessions"
run = '''
#!/usr/bin/env bash
session_arg=""
if [ -n "${usage_session:-}" ]; then
  session_arg="--session ${usage_session}"
fi
uv run nox --error-on-missing-interpreters $session_arg
'''
usage = 'flag "-s --session <session>" help="Specific session to run"'

[tasks.ruff]
description = "Run ruff with arbitrary args (passthrough)"
run = "uv run ruff ${usage_args:-}"
usage = 'arg "[args]" var=#true help="Arguments passed to ruff"'

[tasks.test]
description = "Run tests with default Python version"
run = "{{vars.test_cmd}}"

[tasks."test:310"]
description = "Run tests with Python 3.10"
env = {RUNTIME_TYPE_CHECKING_MODE = "{{vars.runtime_mode}}"}
run = "{{vars.test_cmd}}"
tools.python = "{{vars.py_310}}"

[tasks."test:311"]
description = "Run tests with Python 3.11"
env = {RUNTIME_TYPE_CHECKING_MODE = "{{vars.runtime_mode}}"}
run = "{{vars.test_cmd}}"
tools.python = "{{vars.py_311}}"

[tasks."test:314"]
description = "Run tests with Python 3.12"
env = {RUNTIME_TYPE_CHECKING_MODE = "{{vars.runtime_mode}}"}
run = "{{vars.test_cmd}}"
tools.python = "{{vars.py_314}}"

[tasks."test:all"]
depends = ["test:310", "test:311", "test:314"]
description = "Run tests on all supported Python versions (sequential)"

[tasks."test:all-verbose"]
description = "Run tests on all Python versions with explicit output"
run = '''
#!/usr/bin/env bash
set -euo pipefail
echo "Testing across Python 3.10, 3.11, 3.12..."
echo ""
echo "=== Testing Python 3.10.11 ==="
mise run test:310 || exit 1
echo ""
echo "=== Testing Python 3.11.11 ==="
mise run test:311 || exit 1
echo ""
echo "=== Testing Python 3.14.2 ==="
mise run test:314 || exit 1
echo ""
echo "âœ“ All Python versions passed"
'''

[tasks."types:mypy"]
description = "Run mypy type checker"
run = "uv run mypy"

[tasks."types:pyright"]
description = "Run pyright type checker"
run = "pyright"

[tasks."types:ty"]
description = "Run ty type checker"
run = "uv run ty check calcipy tests"

[tools]
python = ["3.10.11", "3.11.11", "3.14.2"]

[vars]
py_310 = "3.10.11"
py_311 = "3.11.11"
py_314 = "3.14.2"
# Python versions - single source of truth
runtime_mode = "WARNING"
# Shared test configuration
test_cmd = "uv run --group ci pytest tests/"
